# 数据库设计文档

## 数据库选型
- **类型**: SQLite 3
- **库**: react-native-sqlite-storage
- **版本**: 当前最新稳定版
- **文件位置**: App私有目录

---

## 数据库Schema

### 版本管理
```sql
-- 数据库版本表
CREATE TABLE IF NOT EXISTS schema_version (
  version INTEGER PRIMARY KEY,
  applied_at INTEGER NOT NULL
);

INSERT INTO schema_version (version, applied_at) VALUES (1, strftime('%s', 'now'));
```

---

## 核心表结构

### 1. 虚拟人表 (virtual_humans)

存储虚拟人的基本信息和配置

```sql
CREATE TABLE virtual_humans (
  id TEXT PRIMARY KEY,                    -- UUID
  name TEXT NOT NULL,                     -- 虚拟人名字
  age INTEGER,                            -- 年龄
  gender TEXT CHECK(gender IN ('male', 'female', 'other')),
  occupation TEXT,                        -- 职业

  -- 外貌相关
  avatar_url TEXT,                        -- 头像URL（本地路径）
  model_id TEXT NOT NULL,                 -- 3D模型ID
  voice_id TEXT NOT NULL,                 -- 音色ID
  outfit_id TEXT NOT NULL,                -- 服装ID

  -- 性格特质 (JSON格式)
  personality TEXT NOT NULL,
  /*
    {
      "extroversion": 0.0-1.0,    // 外向程度
      "rationality": 0.0-1.0,     // 理性程度
      "seriousness": 0.0-1.0,     // 严肃程度
      "openness": 0.0-1.0,        // 开放程度
      "gentleness": 0.0-1.0       // 温柔程度
    }
  */

  -- 背景信息
  background_story TEXT,                  -- 背景故事
  experiences TEXT,                       -- 人生经历（JSON数组）
  goals TEXT,                            -- 理想目标（JSON）
  relationships TEXT,                     -- 人物关系网（JSON）
  skills TEXT,                           -- 能力技能（JSON数组）

  -- 元数据
  template_id TEXT,                       -- 基于的模板ID（如果有）
  is_template BOOLEAN DEFAULT 0,          -- 是否为模板

  -- 统计数据
  total_conversations INTEGER DEFAULT 0,   -- 总对话次数
  total_messages INTEGER DEFAULT 0,        -- 总消息数
  total_duration INTEGER DEFAULT 0,        -- 总互动时长(秒)

  -- 时间戳
  created_at INTEGER NOT NULL,            -- 创建时间（Unix时间戳）
  updated_at INTEGER NOT NULL,            -- 更新时间
  last_interaction INTEGER,               -- 最后互动时间

  -- 状态
  status TEXT DEFAULT 'active' CHECK(status IN ('active', 'archived', 'draft'))
);

-- 索引
CREATE INDEX idx_vh_status ON virtual_humans(status);
CREATE INDEX idx_vh_last_interaction ON virtual_humans(last_interaction DESC);
CREATE INDEX idx_vh_created_at ON virtual_humans(created_at DESC);
```

---

### 2. 聊天消息表 (chat_messages)

存储所有的聊天记录

```sql
CREATE TABLE chat_messages (
  id TEXT PRIMARY KEY,                    -- UUID
  virtual_human_id TEXT NOT NULL,         -- 关联的虚拟人ID

  -- 消息内容
  role TEXT NOT NULL CHECK(role IN ('user', 'assistant', 'system')),
  content TEXT NOT NULL,                  -- 消息内容
  mode TEXT NOT NULL CHECK(mode IN ('text', 'voice', 'video')),

  -- 语音相关（如果是语音消息）
  audio_url TEXT,                         -- 音频文件路径
  audio_duration INTEGER,                 -- 音频时长（秒）

  -- 情绪相关
  emotion TEXT,                           -- 情绪标签
  /* 可选值: neutral, happy, sad, angry, surprised, thinking, excited */

  -- 元数据
  tokens_used INTEGER,                    -- 消耗的tokens数
  response_time INTEGER,                  -- 响应时间（毫秒）

  -- 时间戳
  timestamp INTEGER NOT NULL,             -- 消息时间（Unix时间戳）

  -- 标记
  is_important BOOLEAN DEFAULT 0,         -- 是否重要
  is_deleted BOOLEAN DEFAULT 0,           -- 软删除标记

  FOREIGN KEY (virtual_human_id) REFERENCES virtual_humans(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_msg_vh_id ON chat_messages(virtual_human_id);
CREATE INDEX idx_msg_timestamp ON chat_messages(timestamp DESC);
CREATE INDEX idx_msg_vh_timestamp ON chat_messages(virtual_human_id, timestamp DESC);
CREATE INDEX idx_msg_important ON chat_messages(is_important) WHERE is_important = 1;

-- 全文搜索（FTS5）
CREATE VIRTUAL TABLE chat_messages_fts USING fts5(
  content,
  content=chat_messages,
  content_rowid=rowid
);

-- FTS触发器
CREATE TRIGGER chat_messages_ai AFTER INSERT ON chat_messages BEGIN
  INSERT INTO chat_messages_fts(rowid, content) VALUES (new.rowid, new.content);
END;

CREATE TRIGGER chat_messages_ad AFTER DELETE ON chat_messages BEGIN
  DELETE FROM chat_messages_fts WHERE rowid = old.rowid;
END;

CREATE TRIGGER chat_messages_au AFTER UPDATE ON chat_messages BEGIN
  UPDATE chat_messages_fts SET content = new.content WHERE rowid = old.rowid;
END;
```

---

### 3. 记忆表 (memories)

存储虚拟人的长期记忆

```sql
CREATE TABLE memories (
  id TEXT PRIMARY KEY,                    -- UUID
  virtual_human_id TEXT NOT NULL,         -- 关联的虚拟人ID

  -- 记忆内容
  category TEXT NOT NULL,
  /* 类别: user_info, preference, event, relationship, fact */

  key TEXT NOT NULL,                      -- 记忆键（如：'user_name', 'favorite_color'）
  value TEXT NOT NULL,                    -- 记忆值

  -- 元数据
  importance INTEGER DEFAULT 3 CHECK(importance BETWEEN 1 AND 5),
  /* 重要性: 1=低, 2=中低, 3=中, 4=中高, 5=高 */

  source_message_id TEXT,                 -- 来源消息ID（如果适用）

  -- 时间相关
  created_at INTEGER NOT NULL,            -- 记忆创建时间
  last_accessed INTEGER,                  -- 最后访问时间
  access_count INTEGER DEFAULT 0,         -- 访问次数

  -- 过期
  expires_at INTEGER,                     -- 过期时间（可选，NULL表示永不过期）

  FOREIGN KEY (virtual_human_id) REFERENCES virtual_humans(id) ON DELETE CASCADE,
  FOREIGN KEY (source_message_id) REFERENCES chat_messages(id) ON DELETE SET NULL
);

-- 索引
CREATE INDEX idx_mem_vh_id ON memories(virtual_human_id);
CREATE INDEX idx_mem_category ON memories(category);
CREATE INDEX idx_mem_importance ON memories(importance DESC);
CREATE INDEX idx_mem_key ON memories(virtual_human_id, key);
CREATE INDEX idx_mem_expires ON memories(expires_at) WHERE expires_at IS NOT NULL;
```

---

### 4. 对话会话表 (conversations)

组织消息为会话（可选，用于会话管理）

```sql
CREATE TABLE conversations (
  id TEXT PRIMARY KEY,                    -- UUID
  virtual_human_id TEXT NOT NULL,         -- 关联的虚拟人ID

  title TEXT,                             -- 会话标题（自动生成或用户设置）
  summary TEXT,                           -- 会话摘要

  -- 统计
  message_count INTEGER DEFAULT 0,        -- 消息数量
  duration INTEGER DEFAULT 0,             -- 会话时长（秒）

  -- 时间戳
  started_at INTEGER NOT NULL,            -- 开始时间
  ended_at INTEGER,                       -- 结束时间（NULL表示进行中）

  -- 标记
  is_active BOOLEAN DEFAULT 1,            -- 是否活跃

  FOREIGN KEY (virtual_human_id) REFERENCES virtual_humans(id) ON DELETE CASCADE
);

-- 消息-会话关联（如果使用会话系统）
ALTER TABLE chat_messages ADD COLUMN conversation_id TEXT
  REFERENCES conversations(id) ON DELETE SET NULL;

CREATE INDEX idx_conv_vh_id ON conversations(virtual_human_id);
CREATE INDEX idx_conv_active ON conversations(is_active) WHERE is_active = 1;
```

---

### 5. 草稿表 (drafts)

保存未完成的虚拟人创建草稿

```sql
CREATE TABLE drafts (
  id TEXT PRIMARY KEY,                    -- UUID

  -- 草稿数据（JSON格式，包含所有创建表单数据）
  data TEXT NOT NULL,

  -- 元数据
  step INTEGER DEFAULT 1,                 -- 当前进行到的步骤
  total_steps INTEGER DEFAULT 5,          -- 总步骤数

  -- 时间戳
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,

  -- 过期时间（30天自动清理）
  expires_at INTEGER NOT NULL
);

CREATE INDEX idx_draft_expires ON drafts(expires_at);
```

---

### 6. 设置表 (settings)

存储用户设置和配置

```sql
CREATE TABLE settings (
  key TEXT PRIMARY KEY,                   -- 设置键
  value TEXT NOT NULL,                    -- 设置值（JSON格式）
  category TEXT NOT NULL,                 -- 分类
  /* 分类: api, voice, video, general, privacy */

  updated_at INTEGER NOT NULL
);

-- 预设设置
INSERT INTO settings (key, value, category, updated_at) VALUES
  ('api_provider', '"openai"', 'api', strftime('%s', 'now')),
  ('api_model', '"gpt-4-turbo"', 'api', strftime('%s', 'now')),
  ('voice_volume', '0.8', 'voice', strftime('%s', 'now')),
  ('voice_speed', '1.0', 'voice', strftime('%s', 'now')),
  ('video_quality', '"medium"', 'video', strftime('%s', 'now')),
  ('theme', '"auto"', 'general', strftime('%s', 'now')),
  ('language', '"zh-CN"', 'general', strftime('%s', 'now'));
```

---

### 7. 素材资源表 (assets)

管理3D模型、音色、服装等素材

```sql
CREATE TABLE assets (
  id TEXT PRIMARY KEY,                    -- 资源ID
  type TEXT NOT NULL CHECK(type IN ('model', 'voice', 'outfit', 'background')),

  name TEXT NOT NULL,                     -- 资源名称
  description TEXT,                       -- 描述

  -- 资源位置
  url TEXT NOT NULL,                      -- 本地路径或远程URL
  thumbnail_url TEXT,                     -- 缩略图

  -- 元数据（JSON格式）
  metadata TEXT,
  /*
    对于model: { "polygonCount": 10000, "hasBlendShapes": true }
    对于voice: { "gender": "female", "age": "young", "style": "sweet" }
    对于outfit: { "category": "casual", "season": "all" }
  */

  -- 标记
  is_builtin BOOLEAN DEFAULT 0,           -- 是否为内置资源
  is_downloaded BOOLEAN DEFAULT 1,        -- 是否已下载（本地）

  -- 时间戳
  created_at INTEGER NOT NULL,

  -- 下载相关（如果是远程资源）
  file_size INTEGER,                      -- 文件大小（字节）
  download_url TEXT                       -- 下载地址
);

CREATE INDEX idx_asset_type ON assets(type);
CREATE INDEX idx_asset_builtin ON assets(is_builtin);
```

---

### 8. 统计数据表 (statistics)

记录每日使用统计

```sql
CREATE TABLE statistics (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  virtual_human_id TEXT,                  -- NULL表示全局统计

  -- 日期
  date TEXT NOT NULL,                     -- YYYY-MM-DD格式

  -- 统计指标
  message_count INTEGER DEFAULT 0,        -- 消息数
  conversation_count INTEGER DEFAULT 0,   -- 对话次数
  total_duration INTEGER DEFAULT 0,       -- 总时长（秒）

  -- 模式统计
  text_count INTEGER DEFAULT 0,
  voice_count INTEGER DEFAULT 0,
  video_count INTEGER DEFAULT 0,

  -- API使用
  tokens_used INTEGER DEFAULT 0,          -- Token消耗
  api_calls INTEGER DEFAULT 0,            -- API调用次数

  FOREIGN KEY (virtual_human_id) REFERENCES virtual_humans(id) ON DELETE CASCADE,
  UNIQUE(virtual_human_id, date)
);

CREATE INDEX idx_stat_date ON statistics(date DESC);
CREATE INDEX idx_stat_vh_date ON statistics(virtual_human_id, date);
```

---

## 数据迁移脚本

### Migration v1 → v2（示例）

```sql
-- 假设v2版本需要添加新字段

ALTER TABLE virtual_humans ADD COLUMN custom_prompt TEXT;

UPDATE schema_version SET version = 2, applied_at = strftime('%s', 'now');
```

---

## 查询示例

### 获取虚拟人及最后一条消息
```sql
SELECT
  vh.*,
  (
    SELECT content
    FROM chat_messages
    WHERE virtual_human_id = vh.id
    ORDER BY timestamp DESC
    LIMIT 1
  ) as last_message
FROM virtual_humans vh
WHERE status = 'active'
ORDER BY last_interaction DESC;
```

### 搜索聊天记录
```sql
SELECT cm.*
FROM chat_messages cm
JOIN chat_messages_fts fts ON cm.rowid = fts.rowid
WHERE fts.content MATCH '关键词'
ORDER BY cm.timestamp DESC;
```

### 获取虚拟人的重要记忆
```sql
SELECT * FROM memories
WHERE virtual_human_id = ?
  AND importance >= 4
ORDER BY importance DESC, last_accessed DESC
LIMIT 10;
```

### 统计过去7天的使用情况
```sql
SELECT
  date,
  SUM(message_count) as total_messages,
  SUM(total_duration) as total_duration,
  SUM(text_count) as text_count,
  SUM(voice_count) as voice_count,
  SUM(video_count) as video_count
FROM statistics
WHERE date >= date('now', '-7 days')
GROUP BY date
ORDER BY date ASC;
```

---

## 数据维护

### 定期清理任务

```sql
-- 清理过期草稿（每天执行）
DELETE FROM drafts WHERE expires_at < strftime('%s', 'now');

-- 清理过期记忆
DELETE FROM memories WHERE expires_at IS NOT NULL AND expires_at < strftime('%s', 'now');

-- 清理90天前的统计数据（可选）
DELETE FROM statistics WHERE date < date('now', '-90 days');
```

### 数据库优化

```sql
-- 定期执行VACUUM压缩数据库
VACUUM;

-- 重建索引
REINDEX;

-- 分析查询优化
ANALYZE;
```

---

## 备份策略

### 自动备份
- 每天备份一次数据库文件
- 保留最近7天的备份
- 云端同步（可选）

### 导出功能
- 支持导出单个虚拟人数据
- 支持导出聊天记录
- 格式：JSON / SQLite文件

---

## 性能考虑

### 分页查询
```typescript
// 示例：分页加载聊天记录
const PAGE_SIZE = 50;

async function loadMessages(virtualHumanId: string, page: number) {
  const offset = page * PAGE_SIZE;
  return db.executeSql(
    `SELECT * FROM chat_messages
     WHERE virtual_human_id = ? AND is_deleted = 0
     ORDER BY timestamp DESC
     LIMIT ? OFFSET ?`,
    [virtualHumanId, PAGE_SIZE, offset]
  );
}
```

### 事务处理
```typescript
// 批量插入消息
async function batchInsertMessages(messages: Message[]) {
  await db.transaction(tx => {
    messages.forEach(msg => {
      tx.executeSql(
        'INSERT INTO chat_messages (...) VALUES (...)',
        [msg.id, msg.content, ...]
      );
    });
  });
}
```

---

**文档版本**: v1.0
**最后更新**: 2026-02-04
