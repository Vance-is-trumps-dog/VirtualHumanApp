# 虚拟人互动App - 技术架构文档

## 项目概述
- **项目名称**: VirtualHumanApp (虚拟人互动应用)
- **版本**: 1.0.0
- **技术栈**: React Native + Unity + Cloud AI
- **目标平台**: iOS 13+ / Android 8.0+

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    用户界面层 (UI Layer)                      │
│  React Native Components + React Navigation + Unity View   │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────────────┐
│                  业务逻辑层 (Business Layer)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  虚拟人管理   │  │  对话管理     │  │  记忆系统     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────────────┐
│                  服务层 (Service Layer)                       │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ AI服务   │ │ 语音服务  │ │ 3D渲染   │ │ 数据服务  │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────────────┐
│                  数据层 (Data Layer)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  SQLite DB   │  │  本地存储     │  │  文件系统     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────────────┐
│                  外部服务 (External Services)                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ OpenAI   │ │ Azure    │ │ Firebase │ │ CDN/OSS  │       │
│  │ API      │ │ Speech   │ │ (可选)   │ │ (可选)   │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
```

---

## 技术栈详细说明

### 前端框架
- **React Native**: 0.73+
  - 跨平台移动应用开发
  - 热更新支持
  - 丰富的第三方库生态

- **TypeScript**: 5.0+
  - 类型安全
  - 更好的IDE支持
  - 代码可维护性强

### UI组件库
- **React Native Paper**: Material Design组件
- **React Native Elements**: 基础UI组件
- **React Native Reanimated**: 高性能动画
- **React Native SVG**: 矢量图形支持

### 导航
- **React Navigation v6**
  - Stack Navigator（页面栈）
  - Tab Navigator（底部标签）
  - Drawer Navigator（侧边栏，可选）
  - Modal（模态框）

### 状态管理
- **Zustand**: 轻量级状态管理
  ```typescript
  // 优点：
  // - API简单直观
  // - 无需Provider包裹
  // - TypeScript支持好
  // - 性能优秀
  ```

### 3D渲染
- **Unity 2022.3 LTS**
  - 成熟的3D引擎
  - 丰富的Asset Store资源
  - 完善的动画系统

- **@azesmway/react-native-unity**
  - Unity与RN桥接
  - 双向消息通信
  - 事件监听

### AI服务
- **OpenAI GPT-4 Turbo**
  - 主对话引擎
  - Context: 128k tokens
  - Function calling支持

- **备选: Anthropic Claude 3**
  - 更长的上下文
  - 更好的安全性

### 语音服务
- **Azure Speech Services**
  - 语音识别 (STT): 支持多语言、实时识别
  - 语音合成 (TTS): 多音色、情感表达
  - 定价合理

### 数据库
- **SQLite** (react-native-sqlite-storage)
  - 轻量级本地数据库
  - 事务支持
  - 全文搜索

### 本地存储
- **AsyncStorage**
  - 键值对存储
  - 用户设置、配置

### 网络请求
- **Axios**: HTTP客户端
- **SWR**: 数据获取和缓存（可选）

### 云端服务（可选）
- **Firebase**
  - Authentication（用户认证）
  - Firestore（云数据库）
  - Storage（文件存储）
  - Analytics（数据分析）

---

## 核心模块设计

### 1. 虚拟人管理模块 (VirtualHumanManager)

**职责**:
- 虚拟人CRUD操作
- 虚拟人列表管理
- 虚拟人配置导入/导出

**主要类**:
```typescript
class VirtualHumanManager {
  async create(data: VirtualHumanCreateDTO): Promise<VirtualHuman>
  async update(id: string, data: Partial<VirtualHuman>): Promise<void>
  async delete(id: string): Promise<void>
  async getById(id: string): Promise<VirtualHuman | null>
  async getAll(): Promise<VirtualHuman[]>
  async exportConfig(id: string): Promise<string>
  async importConfig(config: string): Promise<VirtualHuman>
}
```

### 2. 对话管理模块 (ConversationManager)

**职责**:
- 管理对话会话
- 消息发送/接收
- 上下文管理
- 聊天记录存储

**主要类**:
```typescript
class ConversationManager {
  async sendMessage(
    virtualHumanId: string,
    message: string,
    mode: 'text' | 'voice' | 'video'
  ): Promise<string>

  async getChatHistory(
    virtualHumanId: string,
    limit?: number,
    offset?: number
  ): Promise<Message[]>

  async clearHistory(virtualHumanId: string): Promise<void>
}
```

### 3. AI服务模块 (AIService)

**职责**:
- 调用AI API
- Prompt工程
- 流式响应处理
- 错误处理和重试

**主要类**:
```typescript
class AIService {
  async chat(
    messages: Message[],
    personality: Personality,
    memories: Memory[]
  ): Promise<string>

  async streamChat(
    messages: Message[],
    personality: Personality,
    onChunk: (chunk: string) => void
  ): Promise<void>

  async detectEmotion(text: string): Promise<Emotion>
  async extractMemory(text: string): Promise<Memory[]>
  async generateBackstory(keywords: string[]): Promise<string>
}
```

### 4. 语音服务模块 (SpeechService)

**职责**:
- 语音识别（STT）
- 语音合成（TTS）
- 音频播放控制

**主要类**:
```typescript
class SpeechService {
  async speechToText(audioData: ArrayBuffer): Promise<string>
  async textToSpeech(text: string, voiceId: string): Promise<ArrayBuffer>
  async streamTTS(text: string, voiceId: string): AsyncIterator<ArrayBuffer>
  async getAvailableVoices(): Promise<Voice[]>
}
```

### 5. 记忆系统模块 (MemorySystem)

**职责**:
- 提取对话中的关键信息
- 存储长期记忆
- 检索相关记忆
- 记忆重要性评分

**主要类**:
```typescript
class MemorySystem {
  async extractFromMessage(
    virtualHumanId: string,
    message: string
  ): Promise<Memory[]>

  async store(virtualHumanId: string, memory: Memory): Promise<void>

  async retrieve(
    virtualHumanId: string,
    query: string,
    limit?: number
  ): Promise<Memory[]>

  async getAll(virtualHumanId: string): Promise<Memory[]>
  async delete(memoryId: string): Promise<void>
}
```

### 6. 3D渲染模块 (UnityBridge)

**职责**:
- RN与Unity通信
- 模型切换
- 动画控制
- 表情控制

**主要类**:
```typescript
class UnityBridge {
  sendMessage(gameObject: string, method: string, params: any): void

  switchModel(modelId: string): void
  changeOutfit(outfitId: string): void
  playAnimation(animationName: string): void
  setEmotion(emotion: Emotion): void
  setLipSync(audioData: Float32Array): void

  onMessage(callback: (message: UnityMessage) => void): void
}
```

---

## 数据流设计

### 文字聊天流程
```
用户输入 → ConversationManager
          ↓
      保存用户消息到DB
          ↓
      MemorySystem提取记忆
          ↓
      AIService生成回复
          ↓
      保存AI回复到DB
          ↓
      返回给UI显示
```

### 语音聊天流程
```
用户说话 → SpeechService.STT
          ↓
      转换为文字
          ↓
      进入文字聊天流程
          ↓
      AI回复文字
          ↓
      SpeechService.TTS
          ↓
      播放语音 + UnityBridge口型同步
```

### 视频聊天流程
```
用户输入（语音）→ STT → 文字
          ↓
      AIService生成回复 + 情绪检测
          ↓
      并行执行：
      ├─ TTS生成语音
      ├─ UnityBridge.setEmotion(情绪)
      └─ UnityBridge.setLipSync(音频)
          ↓
      显示虚拟人动画
```

---

## 安全设计

### API密钥管理
- 使用 `react-native-dotenv` 存储环境变量
- 密钥不提交到Git仓库
- 生产环境使用加密存储

### 数据加密
- 敏感数据（聊天记录）使用AES-256加密
- 使用 `react-native-keychain` 存储加密密钥

### 网络安全
- 所有API请求使用HTTPS
- 实现请求签名验证（可选）
- Rate limiting防止滥用

---

## 性能优化策略

### 渲染优化
1. **列表虚拟化**
   - 使用 `FlatList` 而非 `ScrollView`
   - 启用 `removeClippedSubviews`

2. **图片优化**
   - 使用 `react-native-fast-image` 缓存
   - 压缩上传的图片

3. **3D渲染优化**
   - LOD（细节层级）系统
   - 降低多边形数量
   - 纹理压缩

### 内存优化
1. 及时释放未使用的资源
2. 图片懒加载
3. 限制聊天记录加载数量

### 网络优化
1. **请求缓存**
   - AI回复缓存（相同输入）
   - TTS音频缓存

2. **批量请求**
   - 合并多个API调用

3. **超时处理**
   - 设置合理的超时时间
   - 实现重试机制

### 启动优化
1. 懒加载非关键模块
2. 代码分割
3. 预加载关键资源

---

## 错误处理

### 错误分类
1. **网络错误**
   - 超时
   - 无网络连接
   - API返回错误

2. **业务错误**
   - 输入验证失败
   - 资源不存在
   - 权限不足

3. **系统错误**
   - 内存不足
   - 存储空间不足
   - 崩溃

### 错误处理策略
```typescript
// 统一错误处理
class ErrorHandler {
  static handle(error: Error): UserFriendlyError {
    if (error instanceof NetworkError) {
      return {
        title: '网络连接失败',
        message: '请检查网络设置后重试',
        action: 'retry'
      };
    }
    // ... 其他错误类型
  }
}
```

### 日志与监控
- 集成 Sentry 进行崩溃监控
- 关键操作日志记录
- 性能指标收集

---

## 测试策略

### 单元测试
- 工具: Jest
- 覆盖率目标: 80%+
- 重点测试业务逻辑模块

### 集成测试
- 工具: Detox
- 测试关键用户流程

### E2E测试
- 测试完整的对话流程
- 测试虚拟人创建流程

---

## 部署架构

### 开发环境
```
开发机 → Metro Bundler → 模拟器/真机
       ↓
    本地API Mock服务
```

### 生产环境
```
用户设备 → App Store/Google Play
         ↓
      下载安装
         ↓
      运行App → 调用云端API
                ↓
            OpenAI/Azure/Firebase
```

---

## 扩展性设计

### 插件化架构（未来）
- 支持第三方虚拟人模板
- 支持自定义AI模型
- 支持第三方语音引擎

### 国际化
- 使用 `i18next`
- 支持多语言切换
- 文案外部化

### 主题系统
- 支持浅色/深色模式
- 支持自定义主题色

---

## 版本演进路线

### v1.0（MVP）
- 基础文字聊天
- 快速创建虚拟人
- 2D头像

### v1.1
- 语音聊天
- 记忆系统

### v1.2
- 3D虚拟人
- 视频聊天

### v2.0
- 虚拟人市场
- AR功能
- 多虚拟人对话

---

## 技术债务管理

### 已知技术债务
1. MVP阶段使用简化的记忆系统
2. 初期使用预设模板，后续支持完全自定义
3. 3D模型资源有限，后续扩充

### 偿还计划
- 每个Sprint预留20%时间偿还技术债务
- 定期代码Review
- 重构优先级评估

---

**文档版本**: v1.0
**最后更新**: 2026-02-04
**维护者**: 开发团队
